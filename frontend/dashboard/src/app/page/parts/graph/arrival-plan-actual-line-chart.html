@if (chartData) {
  <div class="chart-container">
    <h3 class="chart-title">{{ chartData.config?.title }}</h3>

    <div class="chart-wrapper">
      <svg [attr.viewBox]="viewBox" class="line-chart" preserveAspectRatio="none">
      <defs>
        <!-- グラデーション定義 -->
        <linearGradient id="planGradient" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" style="stop-color:#60A5FA;stop-opacity:0.3" />
          <stop offset="100%" style="stop-color:#60A5FA;stop-opacity:0.05" />
        </linearGradient>
        <linearGradient id="actualGradient" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" style="stop-color:#F472B6;stop-opacity:0.3" />
          <stop offset="100%" style="stop-color:#F472B6;stop-opacity:0.05" />
        </linearGradient>

        <!-- ドロップシャドウ -->
        <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
          <feGaussianBlur in="SourceAlpha" stdDeviation="2"/>
          <feOffset dx="0" dy="2" result="offsetblur"/>
          <feComponentTransfer>
            <feFuncA type="linear" slope="0.3"/>
          </feComponentTransfer>
          <feMerge>
            <feMergeNode/>
            <feMergeNode in="SourceGraphic"/>
          </feMerge>
        </filter>
      </defs>

      <!-- グラフエリア全体のグループ -->
      <g [attr.transform]="'translate(' + margin.left + ',' + margin.top + ')'">

        <!-- グリッド線 -->
        @if (chartData.config?.showGrid) {
          <g class="grid">
            @for (y of getGridLines(); track y) {
              <line
                [attr.x1]="0"
                [attr.y1]="y"
                [attr.x2]="chartWidth"
                [attr.y2]="y"
                class="grid-line"
              />
            }
          </g>
        }

        <!-- X軸 -->
        <g class="x-axis">
          <line
            [attr.x1]="0"
            [attr.y1]="chartHeight"
            [attr.x2]="chartWidth"
            [attr.y2]="chartHeight"
            class="axis-line"
          />
          @for (label of getXAxisLabels(); track label.x) {
            <g class="x-label">
              <line
                [attr.x1]="label.x"
                [attr.y1]="chartHeight"
                [attr.x2]="label.x"
                [attr.y2]="chartHeight + 5"
                class="tick"
              />
            </g>
          }
        </g>

        <!-- Y軸 -->
        <g class="y-axis">
          <line
            [attr.x1]="0"
            [attr.y1]="0"
            [attr.x2]="0"
            [attr.y2]="chartHeight"
            class="axis-line"
          />
          @for (label of getYAxisLabels(); track label.y) {
            <g class="y-label">
              <line
                [attr.x1]="-5"
                [attr.y1]="label.y"
                [attr.x2]="0"
                [attr.y2]="label.y"
                class="tick"
              />
            </g>
          }
        </g>

        <!-- 線グラフの描画 -->
        @for (series of chartData.series; track series.name; let i = $index) {
          <g class="series">
            <!-- エリア（グラデーション塗りつぶし） -->
            <path
              [attr.d]="getAreaPath(i)"
              [attr.fill]="i === 0 ? 'url(#planGradient)' : 'url(#actualGradient)'"
              opacity="0.4"
            />

            <!-- 線 -->
            <polyline
              [attr.points]="getDataPoints(i)"
              [attr.stroke]="series.color"
              [attr.stroke-width]="series.lineWidth || 2"
              [attr.stroke-dasharray]="series.dashed ? '5,5' : 'none'"
              fill="none"
              class="line"
            />

            <!-- データポイント -->
            @if (series.showPoints) {
              <g>
                @for (point of getPointCoordinates(i); track point.x + '-' + point.y) {
                  <circle
                    [attr.cx]="point.x"
                    [attr.cy]="point.y"
                    r="5"
                    [attr.fill]="series.color"
                    stroke="#2a2a2a"
                    stroke-width="2"
                    class="data-point"
                  >
                    <title>{{ series.name }}: {{ point.value }}</title>
                  </circle>
                }
              </g>
            }
          </g>
        }


      </g>
    </svg>

    <!-- HTML要素でテキストを配置 -->
    <!-- X軸ラベル -->
    @for (label of getXAxisLabels(); track label.x) {
      <div
        class="x-axis-label"
        [style.left.px]="label.pixelX"
        [style.top.px]="svgHeight() - 50"
      >
        {{ label.label }}
      </div>
    }

    <!-- Y軸ラベル -->
    @for (label of getYAxisLabels(); track label.y) {
      <div
        class="y-axis-label"
        [style.left.px]="5"
        [style.top.px]="label.pixelY"
      >
        {{ label.label }}
      </div>
    }

    <!-- X軸タイトル -->
    <div
      class="x-axis-title"
      [style.left.px]="getXAxisTitlePosition().pixelX"
      [style.top.px]="getXAxisTitlePosition().pixelY"
    >
      {{ chartData.config?.xAxisLabel }}
    </div>

    <!-- Y軸タイトル -->
    <div
      class="y-axis-title"
      [style.left.px]="getYAxisTitlePosition().pixelX"
      [style.top.px]="getYAxisTitlePosition().pixelY"
    >
      {{ chartData.config?.yAxisLabel }}
    </div>

    <!-- 凡例 -->
    @if (chartData.config?.showLegend) {
      @for (series of chartData.series; track series.name; let i = $index) {
        <div
          class="legend-item"
          [style.left.px]="getLegendPositions()[i]?.pixelX"
          [style.top.px]="getLegendPositions()[i]?.pixelY"
        >
          <div class="legend-background"></div>
          <svg class="legend-icon" width="28" height="18">
            <line x1="0" y1="9" x2="23" y2="9" [attr.stroke]="series.color" stroke-width="2.5" />
            <circle cx="11.5" cy="9" r="4" [attr.fill]="series.color" stroke="#2a2a2a" stroke-width="2" />
          </svg>
          <span class="legend-label">{{ series.name }}</span>
        </div>
      }
    }
  </div>
  </div>
}

@if (!chartData) {
  <div class="no-data">
    データがありません
  </div>
}
